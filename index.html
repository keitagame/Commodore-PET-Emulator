<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Commodore PET Emulator</title>
  <style>
    html, body { margin:0; background:#000; color:#0f0; font-family: monospace; }
    #screen { display:block; margin:auto; image-rendering: pixelated; }
  </style>
</head>
<body>
  <canvas id="screen" width="640" height="400"></canvas>

  <!-- コアモジュールを読み込み -->
  <script type="module">
    import { CPU6502 } from './cpu6502.js';
    import { Bus } from './bus.js';
    import { VIA6522 } from './via6522.js';
    import { TextVideo } from './video.js';
    import { Keyboard } from './keyboard.js';
    import { Basic } from './basic.js';

    const canvas = document.getElementById('screen');

    // モード切替: JS BASIC or ROM 6502
    const MODE = 'JS_BASIC'; // 'ROM_6502'

    if (MODE === 'JS_BASIC') {
      const term = new TextVideo(canvas, 40, 25); // 簡易端末として利用
      const basic = new Basic(term);
      term.clear();
      term.printLine('*** PET-LIKE BASIC ***');
      term.printLine('READY.');
      (async ()=>{
        while (true) {
          const line = await term.readLine('> ');
          try {
            const res = basic.parseLine(line);
            if (res.type === 'IMMEDIATE') await basic.execImmediate(res.tokens);
          } catch (e) {
            term.printLine('? '+(e.message||e));
          }
        }
      })();
    } else {
      // ROM 6502 モード
      const bus = new Bus();
      const cpu = new CPU6502(bus);
      const video = new TextVideo(canvas, 40, 25, 0x8000);
      video.hook(bus);
      const via = new VIA6522(cpu);
      via.hook(bus, 0xE840);
      const kb = new Keyboard();
      kb.hook(bus, /*selAddr*/0xE810, /*readAddr*/0xE812);

      // ROM 読み込み
      const loadROM = async (addr, url) => {
        const buf = await fetch(url).then(r=>r.arrayBuffer());
        bus.mapROM(addr, new Uint8Array(buf));
      };
      await loadROM(0xE000, 'editor.rom');
      await loadROM(0xF000, 'basic.rom');
      await loadROM(0xF800, 'kernal.rom');

      cpu.reset();

      const CLOCK = 1_000_000, FRAME = 60;
      const CYCLES_PER_FRAME = Math.floor(CLOCK/FRAME);
      function frame(){
        let startCy = cpu.cy;
        while ((cpu.cy - startCy) < CYCLES_PER_FRAME) {
          const before = cpu.cy;
          cpu.step();
          const delta = cpu.cy - before;
          via.tick(delta);
        }
        video.render(bus);
        requestAnimationFrame(frame);
      }
      requestAnimationFrame(frame);
    }
  </script>
</body>
</html>
